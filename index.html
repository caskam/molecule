<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Molecule by testinfected</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Molecule</h1>
        <h2>A Rack inspired web micro-framework for easy and fun Java Web Development</h2>
        <a href="https://github.com/testinfected/molecule" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h2>
<a id="quick-start" class="anchor" href="#quick-start" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Quick Start</h2>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">HelloWorld</span> {
    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">main</span>(<span class="pl-k">String</span>[] <span class="pl-v">args</span>) <span class="pl-k">throws</span> <span class="pl-smi">IOException</span> {
        <span class="pl-smi">WebServer</span> server <span class="pl-k">=</span> <span class="pl-smi">WebServer</span><span class="pl-k">.</span>create();
        server<span class="pl-k">.</span>start((request, response) <span class="pl-k">-</span><span class="pl-k">&gt;</span> response<span class="pl-k">.</span>done(<span class="pl-s"><span class="pl-pds">"</span>Hello, World<span class="pl-pds">"</span></span>));
    }
}</pre></div>

<p>Access your application at:</p>

<p><code>http://localhost:8080</code></p>

<h2>
<a id="about" class="anchor" href="#about" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>About</h2>

<p>Molecule is a rack inspired micro web framework for Java, with minimal dependencies. It is fast, small, 
easy to use, easy to learn and easy to extend.</p>

<p>Molecule is great for building micro services or regular web applications. It is designed around simplicity,
testability and freedom of choice. It's more a library than a framework really.</p>

<p>Molecule is small, it weights less than 140k, and will stay as lean as possible. It is pluggable through the concept
of rack middlewares and offers some out-of-the box integrations. You're free to use the built-in options 
or provide your own implementations. </p>

<p>Molecule requires Java 8. It runs an embedded web-server powered by <a href="http://simpleframework.org">Simple</a>. Both are fully asynchronous and non-blocking, which means they can scale to very high loads.</p>

<p>Have fun!</p>

<h2>
<a id="download" class="anchor" href="#download" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Download</h2>

<p>You can get the latest release version from Maven Central:</p>

<div class="highlight highlight-text-xml"><pre>&lt;<span class="pl-ent">dependency</span>&gt;
      &lt;<span class="pl-ent">groupId</span>&gt;com.vtence.molecule&lt;/<span class="pl-ent">groupId</span>&gt;
      &lt;<span class="pl-ent">artifactId</span>&gt;molecule&lt;/<span class="pl-ent">artifactId</span>&gt;
      &lt;<span class="pl-ent">version</span>&gt;0.10&lt;/<span class="pl-ent">version</span>&gt;
&lt;/<span class="pl-ent">dependency</span>&gt;</pre></div>

<p>To use the default web server, you also need to add <a href="http://www.simpleframework.org">Simple</a> as a dependency:</p>

<div class="highlight highlight-text-xml"><pre>&lt;<span class="pl-ent">dependency</span>&gt;
      &lt;<span class="pl-ent">groupId</span>&gt;org.simpleframework&lt;/<span class="pl-ent">groupId</span>&gt;
      &lt;<span class="pl-ent">artifactId</span>&gt;simple-http&lt;/<span class="pl-ent">artifactId</span>&gt;
      &lt;<span class="pl-ent">version</span>&gt;6.0.1&lt;/<span class="pl-ent">version</span>&gt;
      &lt;<span class="pl-ent">scope</span>&gt;runtime&lt;/<span class="pl-ent">scope</span>&gt;
&lt;/<span class="pl-ent">dependency</span>&gt;</pre></div>

<h2>
<a id="want-to-start-with-some-code" class="anchor" href="#want-to-start-with-some-code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Want to start with some code?</h2>

<p>Try out the following examples:</p>

<ul>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/helloworld/HelloWorldExample.java">Hello World</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/simple/SimpleExample.java">Rendering HTML</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/routing/RoutingExample.java">Dynamic Routes</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/files/StaticFilesExample.java">Static Files</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/rest/RESTExample.java">REST</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/async/AsyncExample.java">Asynchronous Processing</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/cookies/CookiesExample.java">Cookies</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/flash/FlashExample.java">Flash</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/locale/LocaleNegotiationExample.java">Locale Negotiation</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/multipart/MultipartExample.java">Multipart Forms</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/templating/TemplatingAndLayoutExample.java">View Templates and Layout</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/session/SessionExample.java">HTTP Sessions</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/multiapps/MultiAppsExample.java">Multiple Applications</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/filtering/FilteringExample.java">Filters</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/middleware/CustomMiddlewareExample.java">Creating a Custom Middleware</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/performance/CachingAndCompressionExample.java">Caching and Compression</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/ssl/SSLExample.java">SSL</a></li>
<li><a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/auth/BasicAuthExample.java">Basic Authentication</a></li>
<li><a href="https://github.com/testinfected/simple-petstore/blob/master/webapp/src/main/java/org/testinfected/petstore/PetStore.java">A Sample Application</a></li>
</ul>

<h2>
<a id="getting-started" class="anchor" href="#getting-started" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Getting Started</h2>

<p>First thing first, you need a server to run your app:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">WebServer</span> server <span class="pl-k">=</span> <span class="pl-smi">WebServer</span><span class="pl-k">.</span>create();</pre></div>

<p>This will set the default web server, which is powered by <a href="http://www.simpleframework.org">Simple</a>, 
to run locally on port 8080.</p>

<p>To start the server, give it an app:</p>

<div class="highlight highlight-source-java"><pre>server<span class="pl-k">.</span>start((request, response) <span class="pl-k">-</span><span class="pl-k">&gt;</span> response<span class="pl-k">.</span>done(<span class="pl-s"><span class="pl-pds">"</span>Hello, World!<span class="pl-pds">"</span></span>));</pre></div>

<p>To stop the server, call the <em>stop</em> method:</p>

<div class="highlight highlight-source-java"><pre>server<span class="pl-k">.</span>stop()</pre></div>

<p>You can optionally specify the interface and port to bound to when creating the server, e.g. if you want to make your server globally available:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">WebServer</span> server <span class="pl-k">=</span> <span class="pl-smi">WebServer</span><span class="pl-k">.</span>create(<span class="pl-s"><span class="pl-pds">"</span>0.0.0.0<span class="pl-pds">"</span></span>, <span class="pl-c1">8088</span>);</pre></div>

<h2>
<a id="asynchronous-processing" class="anchor" href="#asynchronous-processing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Asynchronous Processing</h2>

<p>Molecule uses <a href="http://www.simpleframework.org">Simple</a> as a default webserver.
Both are fully asynchronous and non-blocking. This allows the server to scale to very high loads and handle as many concurrent connections as possible, even when depending on a high latency external resource.</p>

<p>What this means is you can serve your response content from a thread separate to the original servicing thread. For instance your application 
might need to wait for some remote process that takes some time to complete, such as an HTTP or SOAP request to an external server. You can simply 
call this external resource from a different thread, and complete the response when you get the result.</p>

<p>To tell the server that you're ready to serve the response, call the <code>done</code> method on the response.</p>

<p>Look at the <a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/async/AsyncExample.java">Asynchronous example</a>
to see how to serve content from a separate thread.</p>

<h2>
<a id="routing" class="anchor" href="#routing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Routing</h2>

<p>Most modern webapps have nice URLs. Simple URLs are also easier to remember and more user friendly. </p>

<p>Molecule comes with a routing middleware that let you define your URL routes. </p>

<p>Routes let you map incoming requests to different applications based on the request verb and path. A route is composed
of a path pattern, an optional set of verbs to match, and an application endpoint: </p>

<div class="highlight highlight-source-java"><pre>server<span class="pl-k">.</span>start(<span class="pl-k">new</span> <span class="pl-smi">DynamicRoutes</span>() {{
    get(<span class="pl-s"><span class="pl-pds">"</span>/posts/:id<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>to((request, response) <span class="pl-k">-</span><span class="pl-k">&gt;</span> {
        <span class="pl-c">// retrieve a given post</span>
    });
    post(<span class="pl-s"><span class="pl-pds">"</span>/posts<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>to((request, response) <span class="pl-k">-</span><span class="pl-k">&gt;</span> {
        <span class="pl-c">// create a new post</span>
    }); 
    put(<span class="pl-s"><span class="pl-pds">"</span>/posts/:id<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>to((request, response) <span class="pl-k">-</span><span class="pl-k">&gt;</span> {
        <span class="pl-c">// update an existing post</span>
    });
    delete(<span class="pl-s"><span class="pl-pds">"</span>/posts/:id<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>to((request, response) <span class="pl-k">-</span><span class="pl-k">&gt;</span> {
        <span class="pl-c">// delete a post</span>
    }); 
    map(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>to((request, response) <span class="pl-k">-</span><span class="pl-k">&gt;</span> {
        <span class="pl-c">// show the home page</span>
    });
}});</pre></div>

<h3>
<a id="matching" class="anchor" href="#matching" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Matching</h3>

<p>Routes are matched in the order they are defined. If not defined route matches, the default behaviour is to 
render a 404 Not Found. This can be configured to pass the control to any default application.</p>

<p>By default, a route matches a single verb, specified by the method you use, i.e. <em>get</em>, <em>post</em>, <em>put</em>, <em>delete</em>.
That can be changed by providing the verbs as arguments to the <em>via</em> method:</p>

<div class="highlight highlight-source-java"><pre>map(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>via(<span class="pl-c1">GET</span>, <span class="pl-c1">HEAD</span>)<span class="pl-k">.</span>to((request, response) <span class="pl-k">-</span><span class="pl-k">&gt;</span> {
    <span class="pl-c">// show the home page</span>
});</pre></div>

<p>If you don't provide any verbs, <em>map</em> will match on all verbs.</p>

<h3>
<a id="dynamic-parameters" class="anchor" href="#dynamic-parameters" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Dynamic Parameters</h3>

<p>Route patterns can be matched exactly - they are said to be static - or can include named parameters,
 which are then accessible as regular request parameters on the request object:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">// matches "GET /photos/18" and "GET /photos/25"</span>
<span class="pl-c">// request.parameter("id") is either '18' or '25'</span>
get(<span class="pl-s"><span class="pl-pds">"</span>/photos/:id<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>to((request, response) <span class="pl-k">-</span><span class="pl-k">&gt;</span> {
    response<span class="pl-k">.</span>done(<span class="pl-s"><span class="pl-pds">"</span>Photo #<span class="pl-pds">"</span></span> <span class="pl-k">+</span> request<span class="pl-k">.</span>parameter(<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>));
});</pre></div>

<h3>
<a id="custom-matching" class="anchor" href="#custom-matching" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Custom Matching</h3>

<p>You are not limited to the provided match patterns. You can easily implement your own matcher and decide exactly how to match an incoming url to an application.</p>

<p>To do this, use the route definition methods that accept a <em>Matcher</em> rather than a <em>String</em>.</p>

<h2>
<a id="working-with-the-request" class="anchor" href="#working-with-the-request" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Working with the Request</h2>

<p>Applications receive a <code>Request</code> that provide information about the request coming in from the client.</p>

<p>The request represents the environment for the client request, including the headers, the request body as well as parameters and other common things. The <code>Request</code> object is built from information provided by the HTTP server. </p>

<p>Any middleware can modify the content of the request during processing before passing control to the next stage of the middleware pipeline. This of course has no effect on the original HTTP request. See <a href="#middlewares">Middlewares</a> for more information on middlewares and the middleware pipeline.</p>

<h3>
<a id="request" class="anchor" href="#request" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Request</h3>

<div class="highlight highlight-source-java"><pre>request<span class="pl-k">.</span>uri();                          <span class="pl-c">// the uri, e.g. /path?query</span>
request<span class="pl-k">.</span>path();                         <span class="pl-c">// the path info, e.g. /foo</span>
request<span class="pl-k">.</span>remoteIp();                     <span class="pl-c">// ip of the client</span>
request<span class="pl-k">.</span>remoteHost();                   <span class="pl-c">// hostname of the client</span>
request<span class="pl-k">.</span>remotePort();                   <span class="pl-c">// port of the client</span>
request<span class="pl-k">.</span>protocol();                     <span class="pl-c">// protocol, e.g. HTTP or HTTPS</span>
request<span class="pl-k">.</span>timestamp();                    <span class="pl-c">// time the request came in</span>
request<span class="pl-k">.</span>secure();                       <span class="pl-c">// whether the request was made over a secure connection</span>
request<span class="pl-k">.</span>method();                       <span class="pl-c">// HTTP method (e.g.  GET, POST, PUT, etc.)</span>
request<span class="pl-k">.</span>body();                         <span class="pl-c">// the body as a string, decoded using the request charset</span>
request<span class="pl-k">.</span>bodyContent();                  <span class="pl-c">// the raw body content as bytes</span>
request<span class="pl-k">.</span>bodyStream();                   <span class="pl-c">// the body as a stream of bytes</span>
request<span class="pl-k">.</span>parts();                        <span class="pl-c">// list of parts of a multipart/form-data request</span>
request<span class="pl-k">.</span>part(<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>);                   <span class="pl-c">// named part of a multipart/form-data request</span>
request<span class="pl-k">.</span>charset();                      <span class="pl-c">// charset of the body, read from the content type</span>
request<span class="pl-k">.</span>hasHeader(<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>);              <span class="pl-c">// checks presence of a named header</span>
request<span class="pl-k">.</span>header(<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>);                 <span class="pl-c">// value of a given HTTP header</span>
request<span class="pl-k">.</span>headers(<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>);                <span class="pl-c">// list of values of a given HTTP header</span>
request<span class="pl-k">.</span>headerNames();                  <span class="pl-c">// the set of HTTP header names received</span>
request<span class="pl-k">.</span>contentLength();                <span class="pl-c">// length of the body</span>
request<span class="pl-k">.</span>contentType();                  <span class="pl-c">// content type of the body</span>
request<span class="pl-k">.</span>hasParameter(<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>)            <span class="pl-c">// checks for the presence of a request parameter</span>
request<span class="pl-k">.</span>parameter(<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>);              <span class="pl-c">// value of a specific request parameter</span>
request<span class="pl-k">.</span>paremeters(<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>);             <span class="pl-c">// list of values for a specific request parameter</span>
request<span class="pl-k">.</span>parameterNames();               <span class="pl-c">// set of all request parameter names</span>
request<span class="pl-k">.</span>allParameters();                <span class="pl-c">// map of all request parameters</span>
request<span class="pl-k">.</span>attribute(<span class="pl-s"><span class="pl-pds">"</span>key<span class="pl-pds">"</span></span>);               <span class="pl-c">// value of a keyed attribute</span>
request<span class="pl-k">.</span>attribute(<span class="pl-s"><span class="pl-pds">"</span>key<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>value<span class="pl-pds">"</span></span>);      <span class="pl-c">// sets the value of a keyed attribute</span>
request<span class="pl-k">.</span>attributeKeys();                <span class="pl-c">// set of all attibute keys</span>
request<span class="pl-k">.</span>removeAttribute(<span class="pl-s"><span class="pl-pds">"</span>key<span class="pl-pds">"</span></span>);         <span class="pl-c">// removes a keyed attribute</span>
request<span class="pl-k">.</span>attributes();                   <span class="pl-c">// map of all request attributes</span></pre></div>

<p>For the complete documentation, see the Javadoc of the <code>Request</code> class.</p>

<h3>
<a id="attributes" class="anchor" href="#attributes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Attributes</h3>

<p>Request attributes are not sent by the client - as opposed to request parameters. They are used for server-side processing only.</p>

<p>Attributes are a local server storage mechanism, scoped within the request. Whereas request parameters are string literals, request attributes can be any type of <code>Object</code>s.</p>

<h2>
<a id="working-with-the-response" class="anchor" href="#working-with-the-response" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Working with the Response</h2>

<p>Applications respond to client requests by sending data back to the client using the <code>Response</code>. </p>

<p>The response includes a status code and text, headers and an optional body. </p>

<p>Any middleware can modify the content of the response during processing before returning control to the previous stage of the middleware pipeline. See <a href="#middlewares">Middlewares</a> for more information on middlewares and the middleware pipeline.</p>

<h3>
<a id="response" class="anchor" href="#response" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Response</h3>

<div class="highlight highlight-source-java"><pre>response<span class="pl-k">.</span>status(<span class="pl-smi">HttpStatus</span><span class="pl-c1"><span class="pl-k">.</span>OK</span>);         <span class="pl-c">// sets the status</span>
response<span class="pl-k">.</span>statusCode(<span class="pl-c1">400</span>);               <span class="pl-c">// sets the status code</span>
response<span class="pl-k">.</span>statusText(<span class="pl-s"><span class="pl-pds">"</span>Bad Request<span class="pl-pds">"</span></span>);     <span class="pl-c">// sets the status text</span>
response<span class="pl-k">.</span>redirect(<span class="pl-s"><span class="pl-pds">"</span>/url<span class="pl-pds">"</span></span>);              <span class="pl-c">// 303 redirect to /url</span>
response<span class="pl-k">.</span>header(<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>value<span class="pl-pds">"</span></span>);       <span class="pl-c">// sets the single value of a named header</span>
response<span class="pl-k">.</span>addHeader(<span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>value<span class="pl-pds">"</span></span>);    <span class="pl-c">// adds another value to a named header</span>
response<span class="pl-k">.</span>contentType(<span class="pl-s"><span class="pl-pds">"</span>text/html<span class="pl-pds">"</span></span>);      <span class="pl-c">// sets the Content-Type header of the response</span>
response<span class="pl-k">.</span>contentLength(<span class="pl-c1">16384</span>);          <span class="pl-c">// sets the Content-Length header of the response</span>
response<span class="pl-k">.</span>charset(<span class="pl-s"><span class="pl-pds">"</span>utf-8<span class="pl-pds">"</span></span>);              <span class="pl-c">// sets the charset of the response body</span>
response<span class="pl-k">.</span>body(<span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span>);                  <span class="pl-c">// sets the response body as text</span>
response<span class="pl-k">.</span>done();                        <span class="pl-c">// sends the response to the client</span>
response<span class="pl-k">.</span>done(<span class="pl-s"><span class="pl-pds">"</span>text<span class="pl-pds">"</span></span>);                  <span class="pl-c">// sends the specified response text to the client</span></pre></div>

<p>For the complete documentation, see the Javadoc of the <code>Response</code> class.</p>

<p>Note that no response will actually be sent back to the client until the <code>done</code> method is called.
Calling <code>done</code> signals the end of the request processing and triggers sending back the status, 
headers and body.</p>

<h3>
<a id="rendering" class="anchor" href="#rendering" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Rendering</h3>

<p>There are a variety of ways to send back a response to the client. You can render text, binary content, 
the content of a file, XML, JSON, use a view template or render nothing at all. You can specify the content type or HTTP status of the rendered response as well.</p>

<p>Molecule uses the concept of response <code>Body</code> to represent data to send back to the client.</p>

<p>Molecule comes with a few body implementations ready to use for sending text, binary content, the content of a file or
 a view template.</p>

<h4>
<a id="rendering-an-empty-response" class="anchor" href="#rendering-an-empty-response" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Rendering an empty response</h4>

<p>You can render an empty response by not specifying a body at all. In which case, an empty body is used. </p>

<p>So this is perfectly valid:</p>

<div class="highlight highlight-source-java"><pre>response<span class="pl-k">.</span>done();</pre></div>

<h4>
<a id="rendering-text" class="anchor" href="#rendering-text" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Rendering text</h4>

<p>You can send plain text - with no markup at all - back to the browser like this:</p>

<div class="highlight highlight-source-java"><pre>response<span class="pl-k">.</span>done(<span class="pl-s"><span class="pl-pds">"</span>All good<span class="pl-pds">"</span></span>);</pre></div>

<p>Rendering pure text is sometimes useful if you're client is expecting something other than proper HTML.</p>

<h4>
<a id="rendering-html" class="anchor" href="#rendering-html" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Rendering HTML</h4>

<p>You can send an HTML string back to the browser by using a text body to render:</p>

<div class="highlight highlight-source-java"><pre>response<span class="pl-k">.</span>done(<span class="pl-s"><span class="pl-pds">"</span>&lt;html&gt;&lt;body&gt;&lt;h1&gt;It Works&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<span class="pl-pds">"</span></span>);</pre></div>

<p>This can be useful when you're rendering a small snippet of HTML code. However, you might want to consider moving it to a template file if the markup is complex. See <a href="#view-templates">View Templating</a> for more on using templates. </p>

<h4>
<a id="rendering-json" class="anchor" href="#rendering-json" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Rendering JSON</h4>

<p>You can send back JSON to the browser by using a text body. Here's an example using google Gson library:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">Gson</span> gson <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Gson</span>();
response<span class="pl-k">.</span>done(gson<span class="pl-k">.</span>toJSON(<span class="pl-s"><span class="pl-pds">"</span>ok<span class="pl-pds">"</span></span>));</pre></div>

<p>Another option would be to create a your own body implementation - let's call it <code>JSONBody</code> - 
and use your preferred JSON serializer:</p>

<div class="highlight highlight-source-java"><pre>response<span class="pl-k">.</span>done(<span class="pl-k">new</span> <span class="pl-smi">JSONBody</span>(<span class="pl-s"><span class="pl-pds">"</span>ok<span class="pl-pds">"</span></span>));</pre></div>

<p>or with a static factory method:</p>

<div class="highlight highlight-source-java"><pre>response<span class="pl-k">.</span>done(json(<span class="pl-s"><span class="pl-pds">"</span>ok<span class="pl-pds">"</span></span>));</pre></div>

<p>Rendering XML can be done the same way.</p>

<h4>
<a id="rendering-binary-content" class="anchor" href="#rendering-binary-content" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Rendering binary content</h4>

<p>You can send back a raw body as binary like this:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-k">byte</span>[] content <span class="pl-k">=</span> <span class="pl-c1">...</span> <span class="pl-c">//</span>
response<span class="pl-k">.</span>body(content)<span class="pl-k">.</span>done();</pre></div>

<h4>
<a id="rendering-the-content-of-a-file" class="anchor" href="#rendering-the-content-of-a-file" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Rendering the content of a file</h4>

<p>You can use a <code>FileBody</code> to stream the content of a file:</p>

<div class="highlight highlight-source-java"><pre> response<span class="pl-k">.</span>render(<span class="pl-k">new</span> <span class="pl-smi">FileBody</span>(<span class="pl-k">new</span> <span class="pl-smi">File</span>(<span class="pl-s"><span class="pl-pds">"</span>/path/to/file<span class="pl-pds">"</span></span>))))<span class="pl-k">.</span>done();</pre></div>

<p>This will use a default chunk size of <code>8K</code>, although you can specify a different chunk size.</p>

<h4>
<a id="redirection" class="anchor" href="#redirection" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Redirection</h4>

<p>You can trigger a browser redirect using a See Other (303) status code 
using the <code>redirectTo</code> method on the <code>Response</code>:</p>

<div class="highlight highlight-source-java"><pre>response<span class="pl-k">.</span>redirectTo(<span class="pl-s"><span class="pl-pds">"</span>/url<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>done();</pre></div>

<p>If you need to use a different status code, simply change the status: </p>

<div class="highlight highlight-source-java"><pre>response<span class="pl-k">.</span>redirectTo(<span class="pl-s"><span class="pl-pds">"</span>/url<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>statusCode(<span class="pl-c1">301</span>)<span class="pl-k">.</span>done(); <span class="pl-c">// moved permanently</span></pre></div>

<h2>
<a id="cookies" class="anchor" href="#cookies" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Cookies</h2>

<p>To enable cookies support first add the <code>Cookies</code> middleware to your middleware pipeline (see <a href="#middlewares">Middlewares</a> for more information on using middlewares).</p>

<p>This will create a <code>CookieJar</code> and populate that cookie jar with cookies sent by the client. The cookie jar is available as a request attribute:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">CookieJar</span> cookies <span class="pl-k">=</span> <span class="pl-smi">CookieJar</span><span class="pl-k">.</span>get(request);</pre></div>

<p>To read cookies sent by the client:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">Cookie</span> customer <span class="pl-k">=</span> cookies<span class="pl-k">.</span>get(<span class="pl-s"><span class="pl-pds">"</span>customer<span class="pl-pds">"</span></span>);</pre></div>

<p>To send back cookies to the client, all you have to do is add cookies to the jar:</p>

<div class="highlight highlight-source-java"><pre>cookies<span class="pl-k">.</span>add(<span class="pl-s"><span class="pl-pds">"</span>weapon<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>rocket launcher<span class="pl-pds">"</span></span>)
       .path(<span class="pl-s"><span class="pl-pds">"</span>/ammo<span class="pl-pds">"</span></span>)
       .maxAge(<span class="pl-c1">30</span>)</pre></div>

<p>To expire a cookie, discard it from the jar:</p>

<div class="highlight highlight-source-java"><pre>cookies<span class="pl-k">.</span>discard(<span class="pl-s"><span class="pl-pds">"</span>weapon<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>path(<span class="pl-s"><span class="pl-pds">"</span>/ammo<span class="pl-pds">"</span></span>);</pre></div>

<p>For more on cookies, see the <a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/cookies/CookiesExample.java">Cookies example</a>.</p>

<h2>
<a id="sessions" class="anchor" href="#sessions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Sessions</h2>

<h3>
<a id="enabling-sessions-support" class="anchor" href="#enabling-sessions-support" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Enabling sessions support</h3>

<p>To use sessions you need to start your server with session support:</p>

<div class="highlight highlight-source-java"><pre>server<span class="pl-k">.</span>add(<span class="pl-k">new</span> <span class="pl-smi">Cookies</span>())
      .add(<span class="pl-k">new</span> <span class="pl-smi">CookieSessionTracker</span>(<span class="pl-smi">CookieSessionStore</span><span class="pl-k">.</span>secure(<span class="pl-s"><span class="pl-pds">"</span>your secret<span class="pl-pds">"</span></span>);))
      .start(<span class="pl-k">new</span> <span class="pl-smi">DynamicRoutes</span>() {{
      <span class="pl-c">// your routing here</span>
}}</pre></div>

<p>Since HTTP is a stateless protocol and Molecule uses a minimalist approach, sessions are not part of the request. 
Usage of sessions requires the use of a middleware. This means you have full control over the way sessions are tracked and stored.</p>

<p>Molecule comes with a <code>CookieSessionTracker</code> middleware that uses cookies to track sessions across HTTP requests and two session storage mechanisms:</p>

<ul>
<li>An in memory session store, the <code>SessionPool</code>
</li>
<li>A client side storage using encrypted cookies, the <code>CookieSessionStore</code> </li>
</ul>

<h3>
<a id="using-sessions" class="anchor" href="#using-sessions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Using sessions</h3>

<p>Once session support is enabled, the current session is bound to the request:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">Session</span> session <span class="pl-k">=</span> <span class="pl-smi">Session</span><span class="pl-k">.</span>get(request);</pre></div>

<p>One thing to understand is that as long as your server is started with session support, there will <em>always</em> be a session bound to the request. There's no need to check against <code>null</code>. There's no need to ask for session creation either. </p>

<p>The session attached to the request can be a fresh and empty session or the session opened in a previous request. This does not mean a new session is automatically opened for each request though. A fresh session is only persisted if it is modified before the end of the request cycle. This means you can safely read from a new session. </p>

<p>If you write data to the session then it is automatically persisted to the session store you've selected - created in case of a new session or updated in case of an existing session. If you invalidate the session, it will be discarded from the session store automatically.</p>

<p>Some of the things you can do with sessions include:</p>

<pre><code>session.fresh()             // checks if session is new
session.id()                // gets the session id
session.createdAt()         // the session creation time
session.updatedAd()         // the last session update time
session.expires()           // whether this session expires
session.expirationTime()    // this session expiration time, if it expires
session.maxAge(30)          // sets the session to expire after 30s of inactivity
session.contains("key")     // checks if this session contains a keyed attribute
session.get("key")          // returns the keyed attribute
session.remove("key")       // removes a keyed attribute
session.put("key", "value") // writes a key value pair to the session
session.clear()             // clears the session content
session.invalidate()        // invalidates the session
</code></pre>

<p>For more on using sessions, see the <a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/session/SessionExample.java">Session Example</a>.</p>

<h2>
<a id="view-templates" class="anchor" href="#view-templates" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>View Templates</h2>

<p>When your markup becomes complex, you might want to consider moving it to a template file.</p>

<p>Rendering a template requires a <code>RenderingEngine</code>. To use the built-in <code>JMustacheRenderer</code>, first
  add <a href="https://github.com/samskivert/jmustache">JMustache</a> to your dependencies:</p>

<div class="highlight highlight-text-xml"><pre>&lt;<span class="pl-ent">dependency</span>&gt;
    &lt;<span class="pl-ent">groupId</span>&gt;com.samskivert&lt;/<span class="pl-ent">groupId</span>&gt;
    &lt;<span class="pl-ent">artifactId</span>&gt;jmustache&lt;/<span class="pl-ent">artifactId</span>&gt;
    &lt;<span class="pl-ent">version</span>&gt;1.13&lt;/<span class="pl-ent">version</span>&gt;
&lt;/<span class="pl-ent">dependency</span>&gt;</pre></div>

<p>Rendering a template takes a view model and returns a body object to use with the response. Assuming
 a Mustache template file named <i>profile.mustache</i>, here's how we would render the template 
 using an hypothetical <code>Employee</code> object: </p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">// Declare the template engine</span>
<span class="pl-smi">Templates</span> templates <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Templates</span>(<span class="pl-k">new</span> <span class="pl-smi">JMustacheRenderer</span>()<span class="pl-k">.</span>fromDir(<span class="pl-k">new</span> <span class="pl-smi">File</span>(<span class="pl-s"><span class="pl-pds">"</span>/path/to/template/files<span class="pl-pds">"</span></span>)));
<span class="pl-c">// Load the 'profile.mustache' template</span>
<span class="pl-k">Template&lt;<span class="pl-smi">Employee</span>&gt;</span> profile <span class="pl-k">=</span> templates<span class="pl-k">.</span>named(<span class="pl-s"><span class="pl-pds">"</span>profile<span class="pl-pds">"</span></span>);
<span class="pl-c">// Render the template using an Employee instance </span>
response<span class="pl-k">.</span>done(profile<span class="pl-k">.</span>render(<span class="pl-k">new</span> <span class="pl-smi">Employee</span>(<span class="pl-s"><span class="pl-pds">"</span>Bob<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>...<span class="pl-pds">"</span></span>)));</pre></div>

<p>For further information on using view templates, take a look at the <a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/templating/TemplatingAndLayoutExample.java">View Templates and Layout example</a>.</p>

<h2>
<a id="view-layouts" class="anchor" href="#view-layouts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>View Layouts</h2>

<p>Sometimes you want to share a common look and feel for a set of pages. This is when view layouts can help.</p>

<p>Layouts are just templates that are used to decorate existing pages. A layout defines the surroundings of your HTML page. 
It's where you define a common look and feel of your final output. This reverses the common pattern of 
including shared headers and footers in many templates to isolate changes in repeated setups.</p>

<p>Think of the layout rendering process in two steps. </p>

<p>The first step processes the generated HTML view to extract its content. 
This extraction process makes individual pieces of the original page content available to the layout template:</p>

<ul>
<li>the head content, excluding the title</li>
<li>the title</li>
<li>the body content</li>
<li>all the meta parameters</li>
</ul>

<p>The second step merges the content pieces with the layout template to produce the final
result. </p>

<p>Here's a contrived example of a mustache layout template that simply recreates the original page:</p>

<div class="highlight highlight-text-html-basic"><pre>&lt;<span class="pl-ent">html</span>&gt;
&lt;<span class="pl-ent">head</span>&gt;
{{head}}
&lt;<span class="pl-ent">title</span>&gt;{{title}}&lt;/<span class="pl-ent">title</span>&gt;
&lt;/<span class="pl-ent">head</span>&gt;
&lt;<span class="pl-ent">body</span>&gt;
{{body}}
&lt;/<span class="pl-ent">body</span>&gt;
&lt;/<span class="pl-ent">html</span>&gt;</pre></div>

<p>The <code>Layout</code> middleware intercepts generated HTML responses and merges them with layout decorator(s) 
to build the final result:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">// Declare the template engine</span>
<span class="pl-smi">Templates</span> layouts <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Templates</span>(<span class="pl-k">new</span> <span class="pl-smi">JMustacheRenderer</span>()<span class="pl-k">.</span>fromDir(<span class="pl-k">new</span> <span class="pl-smi">File</span>(<span class="pl-s"><span class="pl-pds">"</span>/path/to/layout/templates<span class="pl-pds">"</span></span>)));
<span class="pl-c">// Load the main layout template</span>
<span class="pl-k">Template&lt;<span class="pl-k">Map&lt;<span class="pl-smi">String</span>, <span class="pl-smi">String</span>&gt;</span>&gt;</span> mainLayout <span class="pl-k">=</span> layouts<span class="pl-k">.</span>named(<span class="pl-s"><span class="pl-pds">"</span>main<span class="pl-pds">"</span></span>);

<span class="pl-c">// Apply the main site layout to requests under the / path, in other words to all rendered pages</span>
server<span class="pl-k">.</span>filter(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>, <span class="pl-smi">Layout</span><span class="pl-k">.</span>html(mainLayout))
      .start(<span class="pl-k">new</span> <span class="pl-smi">DynamicRoutes</span>() {{
          <span class="pl-c">// Your routes definitions here</span>
          <span class="pl-c">// ...</span>
      }});
</pre></div>

<p>For more on using layouts, take a look at the <a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/templating/TemplatingAndLayoutExample.java">View Templates and Layout example</a>.</p>

<h2>
<a id="ssl" class="anchor" href="#ssl" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SSL</h2>

<p>To use HTTPS connections, enable SSL on the <code>WebServer</code>. Enabling HTTPS/SSL requires you to have a keystore file, which you can generate using the Java <code>keytool</code>. You specify the location of your keystore, the keystore password 
and the keys password like this:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">WebServer</span> server <span class="pl-k">=</span> <span class="pl-smi">WebServer</span><span class="pl-k">.</span>create();
server<span class="pl-k">.</span>enableSSL(<span class="pl-k">new</span> <span class="pl-smi">File</span>(<span class="pl-s"><span class="pl-pds">"</span>/path/to/keystore/file<span class="pl-pds">"</span></span>), <span class="pl-s"><span class="pl-pds">"</span>keyStorePassword<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>keyPassword<span class="pl-pds">"</span></span>))
      .start(<span class="pl-c1">...</span>);</pre></div>

<p>This will start the server with TLS enabled, trusting all clients.</p>

<p>If you need more control over the type of keystore and algorithms used, you can alternatively pass 
an <code>javax.net.ssl.SSLContext</code> to use.</p>

<p>See the <a href="https://github.com/testinfected/molecule/blob/master/src/test/java/examples/ssl/SSLExample.java">SSL example</a> 
for more details.</p>

<h2>
<a id="testing" class="anchor" href="#testing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Testing</h2>

<p>Molecule provides fluent assertion helpers for unit testing your application endpoints and middlewares.
 It also provides a test HTTP client for integration testing your server.</p>

<p>Add the testing jar to your dependencies to benefit from the test HTTP client and fluent assertion helpers:</p>

<div class="highlight highlight-text-xml"><pre>&lt;<span class="pl-ent">dependency</span>&gt;
      &lt;<span class="pl-ent">groupId</span>&gt;com.vtence.molecule&lt;/<span class="pl-ent">groupId</span>&gt;
      &lt;<span class="pl-ent">artifactId</span>&gt;molecule-tests&lt;/<span class="pl-ent">artifactId</span>&gt;
      &lt;<span class="pl-ent">version</span>&gt;0.10&lt;/<span class="pl-ent">version</span>&gt;
      &lt;<span class="pl-ent">scope</span>&gt;test&lt;/<span class="pl-ent">scope</span>&gt;
&lt;/<span class="pl-ent">dependency</span>&gt;</pre></div>

<p>You will also need to add <a href="http://hamcrest.org/JavaHamcrest/">Hamcrest</a> to your list of dependencies:</p>

<div class="highlight highlight-text-xml"><pre>&lt;<span class="pl-ent">dependency</span>&gt;
    &lt;<span class="pl-ent">groupId</span>&gt;org.hamcrest&lt;/<span class="pl-ent">groupId</span>&gt;
    &lt;<span class="pl-ent">artifactId</span>&gt;java-hamcrest&lt;/<span class="pl-ent">artifactId</span>&gt;
    &lt;<span class="pl-ent">version</span>&gt;2.0.0.0&lt;/<span class="pl-ent">version</span>&gt;
    &lt;<span class="pl-ent">scope</span>&gt;test&lt;/<span class="pl-ent">scope</span>&gt;
&lt;/<span class="pl-ent">dependency</span>&gt;</pre></div>

<h3>
<a id="unit-testing-middlewares-and-application-endpoints" class="anchor" href="#unit-testing-middlewares-and-application-endpoints" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Unit Testing Middlewares and Application Endpoints</h3>

<p>The <code>Request</code> and <code>Response</code> are plain Java objects that you can use directly in your unit tests. They are simple 
representations of the environment for the client request  and the content of the response your application 
wants to send back. They are not wrappers around the actual HTTP request and response, so there's no need to mock
 them:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">Request</span> request <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Request</span>();
<span class="pl-smi">Response</span> response <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Response</span>();

request<span class="pl-k">.</span>header(<span class="pl-s"><span class="pl-pds">"</span>Authorization<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Basic <span class="pl-pds">"</span></span> <span class="pl-k">+</span> mime<span class="pl-k">.</span>encode(<span class="pl-s"><span class="pl-pds">"</span>joe:bad secret<span class="pl-pds">"</span></span>));

<span class="pl-c">// Call your application endpoint</span>
authentication<span class="pl-k">.</span>handle(request, response);

<span class="pl-c">// Make assertions on the response</span>
<span class="pl-c">// ...</span>
</pre></div>

<h4>
<a id="fluent-assertions" class="anchor" href="#fluent-assertions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Fluent Assertions</h4>

<p><code>ResponseAssert</code> provides a fluent interface for asserting the generated response. Based on
the previous example:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-c">// ...</span>
assertThat(response)<span class="pl-k">.</span>hasStatus(<span class="pl-c1">UNAUTHORIZED</span>)
                    .hasHeader(<span class="pl-s"><span class="pl-pds">"</span>WWW-Authenticate<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Basic realm=<span class="pl-cce">\"</span>WallyWorld<span class="pl-cce">\"</span><span class="pl-pds">"</span></span>)
                    .hasContentType(<span class="pl-s"><span class="pl-pds">"</span>text/plain<span class="pl-pds">"</span></span>)
                    .isEmpty()
                    .isDone();</pre></div>

<p><code>RequestAssert</code> helps make assertions on the request:</p>

<div class="highlight highlight-source-java"><pre>assertThat(request)<span class="pl-k">.</span>hasAttribute(<span class="pl-s"><span class="pl-pds">"</span>username<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>joe<span class="pl-pds">"</span></span>);</pre></div>

<p><code>CookieJarAssert</code> and <code>CookieAssert</code> both provide fluent assertions for <code>Cookie</code>s and the <code>CookieJar</code>: </p>

<div class="highlight highlight-source-java"><pre>assertThat(cookieJar)<span class="pl-k">.</span>hasCookie(<span class="pl-s"><span class="pl-pds">"</span>session<span class="pl-pds">"</span></span>)
                     .hasValue(<span class="pl-s"><span class="pl-pds">"</span>sJaAMRYetEJhQcS9s283pMrlGoXr88LkFf0NCOTZb8A<span class="pl-pds">"</span></span>)
                     .isHttpOnly();</pre></div>

<h3>
<a id="integration-testing" class="anchor" href="#integration-testing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Integration Testing</h3>

<p>You can use the test HTTP client to write integration tests for your API or 
test how various parts of your web application interact:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">HttpRequest</span> request <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">HttpRequest</span>(<span class="pl-c1">8080</span>)<span class="pl-k">.</span>followRedirects(<span class="pl-c1">false</span>);
<span class="pl-smi">HttpResponse</span> response <span class="pl-k">=</span> request<span class="pl-k">.</span>content(<span class="pl-smi">Form</span><span class="pl-k">.</span>urlEncoded()<span class="pl-k">.</span>addField(<span class="pl-s"><span class="pl-pds">"</span>username<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>bob<span class="pl-pds">"</span></span>)
                                                         .addField(<span class="pl-s"><span class="pl-pds">"</span>password<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>secret<span class="pl-pds">"</span></span>))
                               .post(<span class="pl-s"><span class="pl-pds">"</span>/login<span class="pl-pds">"</span></span>);</pre></div>

<h4>
<a id="fluent-assertions-1" class="anchor" href="#fluent-assertions-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Fluent Assertions</h4>

<p><code>HttpResponseAssert</code> and <code>HttpCookieAssert</code> provides fluent interfaces for making assertions on the HTTP response
and cookies:</p>

<div class="highlight highlight-source-java"><pre>assertThat(response)<span class="pl-k">.</span>hasStatusCode(<span class="pl-c1">303</span>)
                    .hasHeader(<span class="pl-s"><span class="pl-pds">"</span>Location<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>/users/bob<span class="pl-pds">"</span></span>)
                    .hasCookie(<span class="pl-s"><span class="pl-pds">"</span>session<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>hasMaxAge(<span class="pl-c1">300</span>);</pre></div>

<h2>
<a id="middlewares" class="anchor" href="#middlewares" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Middlewares</h2>

<p>Middlewares are a way to enhance your application with optional building blocks, using a pipeline design. A middleware component sits between the client and the server, processing inbound requests and outbound responses.</p>

<p>Middlewares implement functionality you tend to need across all your applications,
but you don't want to build everytime. Things like <strong>access logging</strong>, <strong>authentication</strong>, 
<strong>compression</strong>, <strong>static files</strong>, <strong>routing</strong>, etc.</p>

<p>Being able to separate the processing of the request (and post-processing of the response) in different stages 
has several benefits:</p>

<ul>
<li>It separate concerns, which helps keep your design clean and application well-structured</li>
<li>It let you only include the functionality you need, so your server is as small and fast as possible </li>
<li>It let you plug in your own processing stages, to customize the behavior of your application</li>
<li>It let you reuse and share middlewares, as elemental building blocks of application behavior</li>
</ul>

<p>For example you could have the following separate stages of the pipeline doing:</p>

<ol>
<li>Capturing internal server errors to render a nice 500 page</li>
<li>Monitoring, logging accesses to the server</li>
<li>Authentication and authorisation, to control access to your applicatoin</li>
<li>Caching, returning a cached result if request has already been processed recently</li>
<li>Compression, to reduce bandwith usage</li>
<li>Security, to prevent attacks such as CSRF</li>
<li>Processing, the actual request processing by your application</li>
</ol>

<h3>
<a id="the-middleware-stack" class="anchor" href="#the-middleware-stack" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The Middleware Stack</h3>

<p>You can think of the Middleware pipeline as a stack, at the bottom of which is your application. When a request comes in, it starts at the top of the stack and goes down until it is processed by your application. The response then goes up the stack backwards through the middleware chain, before it is sent back to the client. </p>

<p>We call it a middleware stack because each part will call the next part in sequence. Or it might not. In fact there are two types of middlewares. Those that modify the request or response and call the next step in the chain, and those that short circuit the stack and return their own response without ever calling anything further down the stack.</p>

<h3>
<a id="building-the-middleware-stack" class="anchor" href="#building-the-middleware-stack" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Building the Middleware Stack</h3>

<p>The simplest way to build your middleware stack is to add middlewares to your WebServer. </p>

<p>For example, suppose we'd like to enhance performance of our application by adding caching and compression:</p>

<div class="highlight highlight-source-java"><pre><span class="pl-smi">WebServer</span> server <span class="pl-k">=</span> <span class="pl-smi">WebServer</span><span class="pl-k">.</span>create();
server<span class="pl-k">.</span>add(<span class="pl-k">new</span> <span class="pl-smi">ContentLengthHeader</span>())
      .add(<span class="pl-k">new</span> <span class="pl-smi">ConditionalGet</span>())
      .add(<span class="pl-k">new</span> <span class="pl-smi">ETag</span>())
      .add(<span class="pl-k">new</span> <span class="pl-smi">Compressor</span>())
      .start(<span class="pl-k">new</span> <span class="pl-smi">DynamicRoutes</span>() {{
          <span class="pl-c">// ...</span>
      }});</pre></div>

<p>Here's what a more complete, real-life middleware stack might look like:</p>

<div class="highlight highlight-source-java"><pre>server<span class="pl-k">.</span>failureReporter(failureReporter)
      .add(<span class="pl-k">new</span> <span class="pl-smi">ServerHeader</span>(<span class="pl-s"><span class="pl-pds">"</span>Simple/6.0.1<span class="pl-pds">"</span></span>))
      .add(<span class="pl-k">new</span> <span class="pl-smi">DateHeader</span>())
      .add(<span class="pl-k">new</span> <span class="pl-smi">ApacheCommonLogger</span>(logger))
      <span class="pl-c">// a custom middleware to redirect non secure requests to HTTPS </span>
      .add(<span class="pl-k">new</span> <span class="pl-smi">ForceSSL</span>())
      .add(<span class="pl-k">new</span> <span class="pl-smi">ContentLengthHeader</span>())
      .mount(<span class="pl-s"><span class="pl-pds">"</span>/api<span class="pl-pds">"</span></span>, <span class="pl-k">new</span> <span class="pl-smi">MiddlewareStack</span>() {{
          use(<span class="pl-k">new</span> <span class="pl-smi">Failsafe</span>());
          use(<span class="pl-k">new</span> <span class="pl-smi">FailureMonitor</span>(failureReporter));
          use(<span class="pl-k">new</span> <span class="pl-smi">ConnectionScope</span>(database));
          <span class="pl-c">// runs the api application</span>
          run(api());
      }})
      .add(<span class="pl-k">new</span> <span class="pl-smi">ConditionalGet</span>())
      .add(<span class="pl-k">new</span> <span class="pl-smi">ETag</span>())
      .add(<span class="pl-k">new</span> <span class="pl-smi">Compressor</span>()<span class="pl-k">.</span>compressibleTypes(<span class="pl-c1">CSS</span>, <span class="pl-c1">HTML</span>))
      <span class="pl-c">// configures the StaticAssets middleware</span>
      .add(staticAssets())
      .add(<span class="pl-k">new</span> <span class="pl-smi">HttpMethodOverride</span>())
      .add(<span class="pl-k">new</span> <span class="pl-smi">Cookies</span>())
      <span class="pl-c">// a custom middleware to redirect based on the preferred user locale</span>
      .add(selectLocale())
      <span class="pl-c">// a custom middleware to display static pages if case of errors</span>
      .add(<span class="pl-k">new</span> <span class="pl-smi">PublicExceptions</span>())
      .add(<span class="pl-k">new</span> <span class="pl-smi">Failsafe</span>())
      .add(<span class="pl-k">new</span> <span class="pl-smi">FailureMonitor</span>(failureReporter))
      .add(<span class="pl-k">new</span> <span class="pl-smi">ConnectionScope</span>(dataSource))
      .add(<span class="pl-k">new</span> <span class="pl-smi">CookieSessionTracker</span>(<span class="pl-smi">CookieSessionStore</span><span class="pl-k">.</span>secure(<span class="pl-s"><span class="pl-pds">"</span>secret<span class="pl-pds">"</span></span>)))
      .add(<span class="pl-k">new</span> <span class="pl-smi">Flash</span>())
      <span class="pl-c">// starts the main application</span>
      .start(webapp());</pre></div>

<p>For more on using middlewares, take a look at the various code examples (see above), 
including the <a href="https://github.com/testinfected/simple-petstore/blob/master/webapp/src/main/java/org/testinfected/petstore/PetStore.java">sample application</a>.</p>

<p>The javadoc of the <code>WebServer</code> class is another good source of information. </p>

<h3>
<a id="available-middlewares" class="anchor" href="#available-middlewares" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Available Middlewares</h3>

<p>Molecule comes with a bunch of handy middlewares that you can use to build your processing pipeline:</p>

<ul>
<li>Router (See <a href="#routing">Routing</a>)</li>
<li>Static Assets </li>
<li>File Server</li>
<li>Apache Common Logger</li>
<li>Apache Combined Logger</li>
<li>Cookies (See <a href="#cookies">Cookies</a>)</li>
<li>Locale Negotiation</li>
<li>Compressor</li>
<li>ETag</li>
<li>Conditional Get</li>
<li>Connection Scope</li>
<li>Server Header</li>
<li>Date Header</li>
<li>Content-Length Header</li>
<li>Filter Map</li>
<li>URL Map</li>
<li>Cookie Session Tracker</li>
<li>Failsafe</li>
<li>Failure Monitor</li>
<li>Not Found</li>
<li>Http Method Override</li>
<li>Layout</li>
<li>Flash</li>
</ul>

<h2>
<a id="living-on-the-edge" class="anchor" href="#living-on-the-edge" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Living on the edge</h2>

<p>If you want the latest development version, grab the latest snapshot from <a href="https://oss.sonatype.org/content/repositories/snapshots">Sonatype snapshots repositories</a>:</p>

<div class="highlight highlight-text-xml"><pre>&lt;<span class="pl-ent">dependency</span>&gt;
      &lt;<span class="pl-ent">groupId</span>&gt;com.vtence.molecule&lt;/<span class="pl-ent">groupId</span>&gt;
      &lt;<span class="pl-ent">artifactId</span>&gt;molecule&lt;/<span class="pl-ent">artifactId</span>&gt;
      &lt;<span class="pl-ent">version</span>&gt;0.11-SNAPSHOT&lt;/<span class="pl-ent">version</span>&gt;
&lt;/<span class="pl-ent">dependency</span>&gt;</pre></div>

<p>New snapshots are pushed to Sonatype on every commit. So you'll always be running the head version. </p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/testinfected/molecule/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/testinfected/molecule/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/testinfected/molecule"></a> is maintained by <a href="https://github.com/testinfected">testinfected</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-16545808-2");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
